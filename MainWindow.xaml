<Window x:Class="CodeBridge.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:hc="https://handyorg.github.io/handycontrol"
        xmlns:local="clr-namespace:CodeBridge"
        xmlns:vm="clr-namespace:CodeBridge.ViewModels"
        xmlns:helpers="clr-namespace:CodeBridge.Helpers"
        xmlns:converters="clr-namespace:CodeBridge.Converters"
        mc:Ignorable="d"
        x:Name="MainWin"
        Title="飞跃侠·CodeBridge"
        Height="850"
        Width="1280"
        MinHeight="600"
        MinWidth="900"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        ResizeMode="CanResizeWithGrip"
        WindowState="Maximized"
        WindowStartupLocation="CenterScreen">

    <!-- DataContext 将在代码中异步设置 -->

    <Window.Resources>
        <!-- BindingProxy for Drawer DataContext -->
        <helpers:BindingProxy x:Key="ViewModelProxy" Data="{Binding}"/>

        <!-- Converters -->
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:String2VisibilityConverter x:Key="String2VisibilityConverter"/>
        <converters:IntToVisibilityConverter x:Key="IntToVisibilityConverter"/>
        <converters:AnyBoolToCollapsedConverter x:Key="AnyBoolToCollapsedConverter"/>
        <converters:ShellTypeToCheckedConverter x:Key="ShellTypeToCheckedConverter"/>

        <!-- ==================== Cyberpunk Theme Resources ==================== -->

        <!-- Colors -->
        <Color x:Key="CyberBlack">#05050A</Color>
        <Color x:Key="CyberDark">#0D0D14</Color>
        <Color x:Key="CyberSurface">#14141F</Color>
        <Color x:Key="CyberBlue">#00D4FF</Color>
        <Color x:Key="CyberPurple">#BD00FF</Color>
        <Color x:Key="CyberPink">#FF0080</Color>
        <Color x:Key="CyberGreen">#00FF9D</Color>
        <Color x:Key="CyberRed">#FF2A6D</Color>
        <Color x:Key="CyberText">#E0E0FF</Color>
        <Color x:Key="CyberTextDim">#6A6A8A</Color>

        <!-- Brushes -->
        <SolidColorBrush x:Key="CyberBlackBrush" Color="{StaticResource CyberBlack}"/>
        <SolidColorBrush x:Key="CyberDarkBrush" Color="{StaticResource CyberDark}"/>
        <SolidColorBrush x:Key="CyberSurfaceBrush" Color="{StaticResource CyberSurface}"/>
        <SolidColorBrush x:Key="CyberBlueBrush" Color="{StaticResource CyberBlue}"/>
        <SolidColorBrush x:Key="CyberPurpleBrush" Color="{StaticResource CyberPurple}"/>
        <SolidColorBrush x:Key="CyberTextBrush" Color="{StaticResource CyberText}"/>
        <SolidColorBrush x:Key="CyberTextDimBrush" Color="{StaticResource CyberTextDim}"/>

        <!-- Global Font Size (放大文字) -->
        <Style TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
        </Style>
        <Style x:Key="LargeText" TargetType="TextBlock">
            <Setter Property="FontSize" Value="16"/>
        </Style>
        <Style x:Key="SmallText" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12"/>
        </Style>
        <Style x:Key="TitleText" TargetType="TextBlock">
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>

        <!-- Neon Gradient Border -->
        <LinearGradientBrush x:Key="NeonBorderBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="{StaticResource CyberBlue}" Offset="0"/>
            <GradientStop Color="{StaticResource CyberPurple}" Offset="0.5"/>
            <GradientStop Color="{StaticResource CyberPink}" Offset="1"/>
        </LinearGradientBrush>

        <!-- Window Background Gradient -->
        <LinearGradientBrush x:Key="WindowBackgroundBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#08080F" Offset="0"/>
            <GradientStop Color="#0A0A14" Offset="0.5"/>
            <GradientStop Color="#0C0C18" Offset="1"/>
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="ToolbarBackground" StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="#12121C" Offset="0"/>
            <GradientStop Color="#0E0E16" Offset="1"/>
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="TitleBarGradient" StartPoint="0,0" EndPoint="1,0">
            <GradientStop Color="#0A0A12" Offset="0"/>
            <GradientStop Color="#0C0C16" Offset="0.5"/>
            <GradientStop Color="#0A0A12" Offset="1"/>
        </LinearGradientBrush>

        <!-- Window Control Button Style -->
        <Style x:Key="WindowControlButton" TargetType="Button">
            <Setter Property="Width" Value="46"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource CyberTextDimBrush}"/>
            <Setter Property="FontFamily" Value="Segoe MDL2 Assets"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#20FFFFFF"/>
                                <Setter Property="Foreground" Value="{StaticResource CyberBlueBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="WindowCloseButton" TargetType="Button" BasedOn="{StaticResource WindowControlButton}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#E81123"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Cyber Toggle Switch Style -->
        <Style x:Key="CyberToggleSwitchStyle" TargetType="ToggleButton">
            <Setter Property="Width" Value="44"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Grid>
                            <!-- Track Background -->
                            <Border x:Name="Track"
                                    Width="44" Height="24"
                                    CornerRadius="12"
                                    Background="#1A1A2A"
                                    BorderBrush="#2A2A40"
                                    BorderThickness="1"/>
                            <!-- Thumb - 使用 Margin 控制位置，OFF状态在左边 -->
                            <Border x:Name="Thumb"
                                    Width="18" Height="18"
                                    CornerRadius="9"
                                    Background="#6A6A8A"
                                    HorizontalAlignment="Left"
                                    VerticalAlignment="Center"
                                    Margin="3,0,23,0"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <!-- Checked State - ON状态滑块在右边，青色带辉光 -->
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Track" Property="Background" Value="#1500D4FF"/>
                                <Setter TargetName="Track" Property="BorderBrush" Value="#00D4FF"/>
                                <Setter TargetName="Thumb" Property="Background" Value="#00D4FF"/>
                                <Setter TargetName="Thumb" Property="Margin" Value="23,0,3,0"/>
                                <Setter TargetName="Thumb" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect Color="#00D4FF" BlurRadius="8" ShadowDepth="0" Opacity="0.6"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <!-- Hover State -->
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Track" Property="BorderBrush" Value="#3A3A5A"/>
                            </Trigger>
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsMouseOver" Value="True"/>
                                    <Condition Property="IsChecked" Value="True"/>
                                </MultiTrigger.Conditions>
                                <Setter TargetName="Track" Property="BorderBrush" Value="#00D4FF"/>
                                <Setter TargetName="Track" Property="Background" Value="#2000D4FF"/>
                            </MultiTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Tech Button Style -->
        <Style x:Key="TechButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="#2A2A40"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Foreground" Value="{StaticResource CyberBlueBrush}"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#1500D4FF"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource CyberBlueBrush}"/>
                                <Setter TargetName="border" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect Color="{StaticResource CyberBlue}" BlurRadius="12" ShadowDepth="0" Opacity="0.5"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#3000D4FF"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="TechPrimaryButtonStyle" TargetType="Button" BasedOn="{StaticResource TechButtonStyle}">
            <Setter Property="Background" Value="#1500D4FF"/>
            <Setter Property="BorderBrush" Value="{StaticResource CyberBlueBrush}"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>

        <!-- Cyber TabItem Style with Marquee Neon Border -->
        <Style x:Key="CyberTabItemStyle" TargetType="hc:TabItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#707090"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="Margin" Value="4,0"/>
            <Setter Property="MinWidth" Value="120"/>
            <Setter Property="MinHeight" Value="36"/>
            <Setter Property="Padding" Value="16,8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="hc:TabItem">
                        <Grid x:Name="Root" MinWidth="{TemplateBinding MinWidth}" MinHeight="{TemplateBinding MinHeight}">
                            <!-- Outer Glow Border (for selected) - 始终存在，通过 Opacity 控制 -->
                            <Border x:Name="GlowBorder"
                                    CornerRadius="6"
                                    Margin="-2"
                                    Opacity="0"
                                    BorderThickness="4"
                                    Background="Transparent">
                                <Border.BorderBrush>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="#4000D4FF" Offset="0"/>
                                        <GradientStop Color="#40BD00FF" Offset="0.5"/>
                                        <GradientStop Color="#4000D4FF" Offset="1"/>
                                    </LinearGradientBrush>
                                </Border.BorderBrush>
                                <Border.Effect>
                                    <BlurEffect Radius="10"/>
                                </Border.Effect>
                            </Border>

                            <!-- Main Border -->
                            <Border x:Name="MainBorder"
                                    Background="#0A0A14"
                                    BorderThickness="1"
                                    BorderBrush="#1A1A2A"
                                    CornerRadius="6"
                                    Padding="{TemplateBinding Padding}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Tab Content -->
                                    <ContentPresenter x:Name="ContentPresenter"
                                                      Grid.Column="0"
                                                      ContentSource="Header"
                                                      HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                      VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                      RecognizesAccessKey="True"
                                                      Margin="0,0,4,0"/>

                                    <!-- Close Button -->
                                    <Button x:Name="CloseButton"
                                            Grid.Column="1"
                                            Width="18" Height="18"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Foreground="#505070"
                                            FontSize="12"
                                            FontWeight="Bold"
                                            Content="✕"
                                            Cursor="Hand"
                                            VerticalAlignment="Center"
                                            Margin="4,0,0,0"
                                            Visibility="Collapsed"
                                            Command="{Binding DataContext.CloseTabCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}">
                                        <Button.Template>
                                            <ControlTemplate TargetType="Button">
                                                <Border x:Name="CloseBorder"
                                                        Background="{TemplateBinding Background}"
                                                        CornerRadius="3"
                                                        Width="18" Height="18">
                                                    <TextBlock Text="{TemplateBinding Content}"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"
                                                               FontSize="10"
                                                               Foreground="{TemplateBinding Foreground}"/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="CloseBorder" Property="Background" Value="#40FF2A6D"/>
                                                        <Setter Property="Foreground" Value="#FF2A6D"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Button.Template>
                                    </Button>
                                </Grid>
                            </Border>

                            <!-- Animated Neon Border (for selected) - 动画始终运行，通过 Opacity 控制显示 -->
                            <Border x:Name="NeonBorder"
                                    CornerRadius="6"
                                    BorderThickness="2"
                                    Opacity="0"
                                    IsHitTestVisible="False">
                                <Border.BorderBrush>
                                    <LinearGradientBrush x:Name="NeonGradient" StartPoint="0,0" EndPoint="1,1">
                                        <LinearGradientBrush.RelativeTransform>
                                            <RotateTransform x:Name="NeonRotation" CenterX="0.5" CenterY="0.5" Angle="0"/>
                                        </LinearGradientBrush.RelativeTransform>
                                        <GradientStop Color="#00D4FF" Offset="0"/>
                                        <GradientStop Color="#BD00FF" Offset="0.33"/>
                                        <GradientStop Color="#FF0080" Offset="0.66"/>
                                        <GradientStop Color="#00D4FF" Offset="1"/>
                                    </LinearGradientBrush>
                                </Border.BorderBrush>
                            </Border>

                            <!-- Bottom Active Indicator -->
                            <Border x:Name="Indicator"
                                    VerticalAlignment="Bottom"
                                    HorizontalAlignment="Center"
                                    Width="50"
                                    Height="3"
                                    CornerRadius="1.5"
                                    Margin="0,0,0,-1"
                                    Opacity="0"
                                    IsHitTestVisible="False">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Color="#00D4FF" Offset="0"/>
                                        <GradientStop Color="#BD00FF" Offset="1"/>
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Border.Effect>
                                    <DropShadowEffect Color="#00D4FF" BlurRadius="10" ShadowDepth="0" Opacity="1"/>
                                </Border.Effect>
                            </Border>
                        </Grid>

                        <ControlTemplate.Triggers>
                            <!-- Hover State - 显示关闭按钮 -->
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="#B0B0D0"/>
                                <Setter TargetName="MainBorder" Property="Background" Value="#12121C"/>
                                <Setter TargetName="MainBorder" Property="BorderBrush" Value="#2A2A40"/>
                                <Setter TargetName="CloseButton" Property="Visibility" Value="Visible"/>
                            </Trigger>

                            <!-- Selected State - 用动画实现平滑过渡 -->
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Panel.ZIndex" Value="10"/>
                                <Setter TargetName="MainBorder" Property="Background" Value="Transparent"/>
                                <Setter TargetName="MainBorder" Property="BorderBrush" Value="Transparent"/>
                                <Setter TargetName="CloseButton" Property="Visibility" Value="Visible"/>
                                <Setter TargetName="CloseButton" Property="Foreground" Value="#8080A0"/>
                                <Trigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <!-- 淡入效果 -->
                                            <DoubleAnimation Storyboard.TargetName="NeonBorder"
                                                             Storyboard.TargetProperty="Opacity"
                                                             To="1" Duration="0:0:0.3"/>
                                            <DoubleAnimation Storyboard.TargetName="GlowBorder"
                                                             Storyboard.TargetProperty="Opacity"
                                                             To="1" Duration="0:0:0.3"/>
                                            <DoubleAnimation Storyboard.TargetName="Indicator"
                                                             Storyboard.TargetProperty="Opacity"
                                                             To="1" Duration="0:0:0.3"/>
                                            <!-- 霓虹边框旋转动画 -->
                                            <DoubleAnimation Storyboard.TargetName="NeonRotation"
                                                             Storyboard.TargetProperty="Angle"
                                                             From="0" To="360"
                                                             Duration="0:0:3"
                                                             RepeatBehavior="Forever"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </Trigger.EnterActions>
                                <Trigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <!-- 淡出效果 -->
                                            <DoubleAnimation Storyboard.TargetName="NeonBorder"
                                                             Storyboard.TargetProperty="Opacity"
                                                             To="0" Duration="0:0:0.2"/>
                                            <DoubleAnimation Storyboard.TargetName="GlowBorder"
                                                             Storyboard.TargetProperty="Opacity"
                                                             To="0" Duration="0:0:0.2"/>
                                            <DoubleAnimation Storyboard.TargetName="Indicator"
                                                             Storyboard.TargetProperty="Opacity"
                                                             To="0" Duration="0:0:0.2"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </Trigger.ExitActions>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 覆盖 HandyControl TabControl 样式，移除灰色背景 -->
        <!-- 注意：重写 Template 以解决背景和裁切问题 -->
        <Style x:Key="CyberTabControlStyle" TargetType="hc:TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="hc:TabControl">
                        <Grid ClipToBounds="False" KeyboardNavigation.TabNavigation="Local">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <ItemsPresenter Grid.Row="0" ClipToBounds="False"/>
                            <ContentPresenter Grid.Row="1" ContentSource="SelectedContent" ClipToBounds="False"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

    </Window.Resources>

    <!-- Main Container with Neon Border -->
    <Border x:Name="MainBorder"
            Background="{StaticResource WindowBackgroundBrush}"
            BorderBrush="{StaticResource NeonBorderBrush}"
            BorderThickness="1"
            CornerRadius="8"
            Margin="5">
        <Border.Effect>
            <DropShadowEffect Color="{StaticResource CyberPurple}" BlurRadius="20" ShadowDepth="0" Opacity="0.3"/>
        </Border.Effect>

        <Grid>
            <!-- Loading Overlay -->
            <Grid x:Name="LoadingOverlay" Panel.ZIndex="100" Background="#F0050508">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <!-- Logo -->
                    <TextBlock Text="◈"
                               Foreground="{StaticResource CyberBlueBrush}"
                               FontSize="48"
                               HorizontalAlignment="Center">
                        <TextBlock.Effect>
                            <DropShadowEffect Color="{StaticResource CyberBlue}" BlurRadius="20" ShadowDepth="0" Opacity="0.8"/>
                        </TextBlock.Effect>
                    </TextBlock>

                    <!-- App Name -->
                    <TextBlock Text="QIANTERMINALCODE"
                               Foreground="{StaticResource CyberTextBrush}"
                               FontSize="24"
                               FontWeight="Bold"
                               FontFamily="Consolas"
                               HorizontalAlignment="Center"
                               Margin="0,10,0,0"/>

                    <!-- Loading Progress Bar -->
                    <Border Width="200" Height="2" Background="#1A1A2A" CornerRadius="1" Margin="0,20,0,0">
                        <Border x:Name="LoadingBar" Width="0" Height="2" Background="{StaticResource CyberBlueBrush}"
                                CornerRadius="1" HorizontalAlignment="Left">
                            <Border.Effect>
                                <DropShadowEffect Color="{StaticResource CyberBlue}" BlurRadius="8" ShadowDepth="0" Opacity="0.6"/>
                            </Border.Effect>
                        </Border>
                    </Border>

                    <!-- Loading Text -->
                    <TextBlock x:Name="LoadingText"
                               Text="正在初始化..."
                               Foreground="{StaticResource CyberTextDimBrush}"
                               FontSize="12"
                               FontFamily="Consolas"
                               HorizontalAlignment="Center"
                               Margin="0,15,0,0"/>
                </StackPanel>
            </Grid>

            <!-- Main Content -->
            <Grid x:Name="MainContent">
                <Grid.RowDefinitions>
                    <RowDefinition Height="32"/>  <!-- Title Bar -->
                    <RowDefinition Height="Auto"/> <!-- Tabs -->
                    <RowDefinition Height="Auto"/> <!-- Toolbar -->
                    <RowDefinition Height="*"/>    <!-- Terminal Content -->
                </Grid.RowDefinitions>

            <!-- Row 0: Custom Title Bar -->
            <Border Grid.Row="0"
                    Background="{StaticResource TitleBarGradient}"
                    CornerRadius="8,8,0,0"
                    MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- App Icon & Title -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="12,0,0,0" VerticalAlignment="Center">
                        <TextBlock Text="◈" Foreground="{StaticResource CyberBlueBrush}" FontSize="14" VerticalAlignment="Center"/>
                        <TextBlock Text="  QIANTERMINALCODE"
                                   Foreground="{StaticResource CyberTextDimBrush}"
                                   FontSize="11"
                                   FontWeight="SemiBold"
                                   FontFamily="Consolas"
                                   VerticalAlignment="Center"
                                   Margin="6,0,0,0"/>
                        <TextBlock Text=" // TERMINAL"
                                   Foreground="#3A3A5A"
                                   FontSize="11"
                                   FontFamily="Consolas"
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Decorative Center Line -->
                    <Border Grid.Column="1" Height="1" VerticalAlignment="Center" Margin="20,0">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                <GradientStop Color="Transparent" Offset="0"/>
                                <GradientStop Color="#2A2A40" Offset="0.3"/>
                                <GradientStop Color="#2A2A40" Offset="0.7"/>
                                <GradientStop Color="Transparent" Offset="1"/>
                            </LinearGradientBrush>
                        </Border.Background>
                    </Border>

                    <!-- Window Controls -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal">
                        <!-- Settings Button -->
                        <Button Style="{StaticResource WindowControlButton}"
                                Command="{Binding ToggleSettingsCommand}"
                                ToolTip="设置">
                            <TextBlock Text="&#xE713;" FontFamily="Segoe MDL2 Assets" FontSize="12"/>
                        </Button>

                        <!-- Notification Button -->
                        <Button Style="{StaticResource WindowControlButton}"
                                Command="{Binding ToggleNotificationCenterCommand}"
                                ToolTip="通知中心">
                            <Grid>
                                <TextBlock Text="&#xEA8F;" FontFamily="Segoe MDL2 Assets" FontSize="12"/>
                                <!-- Notification Badge -->
                                <Border Background="#FF2A6D" CornerRadius="6" MinWidth="12" Height="12"
                                        HorizontalAlignment="Right" VerticalAlignment="Top"
                                        Margin="6,-4,-6,0" Padding="3,0"
                                        Visibility="{Binding UnreadNotificationCount, Converter={StaticResource IntToVisibilityConverter}}">
                                    <TextBlock Text="{Binding UnreadNotificationCount}"
                                               Foreground="White" FontSize="8" FontWeight="Bold"
                                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </Grid>
                        </Button>

                        <Button Content="&#xE921;" Style="{StaticResource WindowControlButton}" Click="MinimizeButton_Click" ToolTip="最小化"/>
                        <Button x:Name="MaximizeButton" Content="&#xE922;" Style="{StaticResource WindowControlButton}" Click="MaximizeButton_Click" ToolTip="最大化"/>
                        <Button Content="&#xE8BB;" Style="{StaticResource WindowCloseButton}" Click="CloseButton_Click" ToolTip="关闭"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Row 1: Tab Bar - 使用标准 WPF TabControl 避免 HandyControl 样式干扰 -->
            <Border Grid.Row="1" Background="Transparent" BorderThickness="0" Padding="10,12,10,20" ClipToBounds="False">
                <TabControl x:Name="MainTabControl"
                            ItemsSource="{Binding TerminalTabs}"
                            SelectedItem="{Binding SelectedTab}"
                            Background="Transparent"
                            BorderThickness="0"
                            Padding="0"
                            PreviewMouseDoubleClick="TabControl_PreviewMouseDoubleClick">
                    <TabControl.Template>
                        <ControlTemplate TargetType="TabControl">
                            <Grid ClipToBounds="False">
                                <TabPanel IsItemsHost="True" Background="Transparent" ClipToBounds="False"/>
                            </Grid>
                        </ControlTemplate>
                    </TabControl.Template>
                    <TabControl.ItemContainerStyle>
                        <Style TargetType="TabItem">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Foreground" Value="#707090"/>
                            <Setter Property="Margin" Value="0,0,0,0"/>
                            <Setter Property="Padding" Value="14,8"/>
                            <Setter Property="Cursor" Value="Hand"/>
                            <Setter Property="AllowDrop" Value="True"/>
                            <EventSetter Event="PreviewMouseLeftButtonDown" Handler="TabItem_PreviewMouseLeftButtonDown"/>
                            <EventSetter Event="PreviewMouseMove" Handler="TabItem_PreviewMouseMove"/>
                            <EventSetter Event="Drop" Handler="TabItem_Drop"/>
                            <EventSetter Event="DragEnter" Handler="TabItem_DragEnter"/>
                            <EventSetter Event="DragLeave" Handler="TabItem_DragLeave"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="TabItem">
                                        <Grid x:Name="Root" Background="Transparent" ClipToBounds="False" Margin="4,0,4,8">
                                            <!-- Glow Effect -->
                                            <Border x:Name="GlowBorder"
                                                    CornerRadius="6"
                                                    Margin="-4"
                                                    Opacity="0"
                                                    IsHitTestVisible="False">
                                                <Border.Background>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                        <GradientStop Color="#5000D4FF" Offset="0"/>
                                                        <GradientStop Color="#50BD00FF" Offset="0.5"/>
                                                        <GradientStop Color="#5000D4FF" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Border.Background>
                                                <Border.Effect>
                                                    <BlurEffect Radius="12"/>
                                                </Border.Effect>
                                            </Border>

                                            <!-- Main Border -->
                                            <Border x:Name="MainBorder"
                                                    Background="#0A0A14"
                                                    BorderThickness="1"
                                                    BorderBrush="#252535"
                                                    CornerRadius="6"
                                                    Padding="{TemplateBinding Padding}"
                                                    MinWidth="100">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <ContentPresenter ContentSource="Header" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                                    <!-- Close Button -->
                                                    <Button x:Name="CloseButton"
                                                            Grid.Column="1"
                                                            Width="18" Height="18"
                                                            Background="Transparent"
                                                            BorderThickness="0"
                                                            Content="✕"
                                                            FontSize="10"
                                                            Foreground="#505070"
                                                            Cursor="Hand"
                                                            Visibility="Collapsed"
                                                            Command="{Binding DataContext.CloseTabCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                            CommandParameter="{Binding}">
                                                        <Button.Template>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border x:Name="CloseBg" Background="Transparent" CornerRadius="3">
                                                                    <TextBlock Text="✕" FontSize="10" Foreground="{TemplateBinding Foreground}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter TargetName="CloseBg" Property="Background" Value="#40FF2A6D"/>
                                                                        <Setter Property="Foreground" Value="#FF2A6D"/>
                                                                    </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Button.Template>
                                                    </Button>
                                                </Grid>
                                            </Border>

                                            <!-- Neon Border -->
                                            <Border x:Name="NeonBorder"
                                                    CornerRadius="6"
                                                    BorderThickness="2"
                                                    Opacity="0"
                                                    IsHitTestVisible="False">
                                                <Border.BorderBrush>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                        <LinearGradientBrush.RelativeTransform>
                                                            <RotateTransform x:Name="NeonRotation" CenterX="0.5" CenterY="0.5"/>
                                                        </LinearGradientBrush.RelativeTransform>
                                                        <GradientStop Color="#00D4FF" Offset="0"/>
                                                        <GradientStop Color="#BD00FF" Offset="0.33"/>
                                                        <GradientStop Color="#FF0080" Offset="0.66"/>
                                                        <GradientStop Color="#00D4FF" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Border.BorderBrush>
                                            </Border>

                                            <!-- Bottom Indicator -->
                                            <Border x:Name="Indicator"
                                                    VerticalAlignment="Bottom"
                                                    HorizontalAlignment="Center"
                                                    Width="40" Height="3"
                                                    CornerRadius="1.5"
                                                    Margin="0,0,0,-8"
                                                    Opacity="0">
                                                <Border.Background>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                        <GradientStop Color="#00D4FF" Offset="0"/>
                                                        <GradientStop Color="#BD00FF" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Border.Background>
                                                <Border.Effect>
                                                    <DropShadowEffect Color="#00D4FF" BlurRadius="8" ShadowDepth="0"/>
                                                </Border.Effect>
                                            </Border>
                                        </Grid>

                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Foreground" Value="#A0A0C0"/>
                                                <Setter TargetName="MainBorder" Property="Background" Value="#101018"/>
                                                <Setter TargetName="MainBorder" Property="BorderBrush" Value="#303050"/>
                                                <Setter TargetName="CloseButton" Property="Visibility" Value="Visible"/>
                                            </Trigger>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter Property="Foreground" Value="White"/>
                                                <Setter Property="Panel.ZIndex" Value="10"/>
                                                <Setter TargetName="MainBorder" Property="Background" Value="#0D1520"/>
                                                <Setter TargetName="MainBorder" Property="BorderBrush" Value="Transparent"/>
                                                <Setter TargetName="NeonBorder" Property="Opacity" Value="1"/>
                                                <Setter TargetName="GlowBorder" Property="Opacity" Value="1"/>
                                                <Setter TargetName="Indicator" Property="Opacity" Value="1"/>
                                                <Setter TargetName="CloseButton" Property="Visibility" Value="Visible"/>
                                                <Trigger.EnterActions>
                                                    <BeginStoryboard>
                                                        <Storyboard>
                                                            <DoubleAnimation Storyboard.TargetName="NeonRotation"
                                                                             Storyboard.TargetProperty="Angle"
                                                                             From="0" To="360" Duration="0:0:3"
                                                                             RepeatBehavior="Forever"/>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </Trigger.EnterActions>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </TabControl.ItemContainerStyle>
                    <TabControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <Grid Width="8" Height="8" Margin="0,0,8,0" VerticalAlignment="Center">
                                    <Ellipse Fill="{Binding IsRunning, Converter={StaticResource BoolToStatusColorConverter}}"/>
                                    <Ellipse>
                                        <Ellipse.Effect>
                                            <BlurEffect Radius="4"/>
                                        </Ellipse.Effect>
                                        <Ellipse.Fill>
                                            <SolidColorBrush Color="{Binding IsRunning, Converter={StaticResource BoolToStatusColorConverter}}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                </Grid>
                                <TextBlock Text="{Binding DisplayName}"
                                           FontSize="12"
                                           FontWeight="Medium"
                                           VerticalAlignment="Center"
                                           MaxWidth="100"
                                           TextTrimming="CharacterEllipsis"
                                           ToolTip="{Binding Config.WorkingDirectory}"/>
                            </StackPanel>
                        </DataTemplate>
                    </TabControl.ItemTemplate>
                </TabControl>
            </Border>

            <!-- Row 2: Toolbar -->
            <Border Grid.Row="2" Background="{StaticResource ToolbarBackground}" BorderBrush="#1A1A2A" BorderThickness="0,0,0,1" Padding="12,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/> <!-- Drawer Toggle -->
                        <ColumnDefinition Width="Auto"/> <!-- Notification -->
                        <ColumnDefinition Width="Auto"/> <!-- Tab Rename -->
                        <ColumnDefinition Width="*"/>    <!-- Path Input -->
                        <ColumnDefinition Width="Auto"/> <!-- Browse -->
                        <ColumnDefinition Width="Auto"/> <!-- Options -->
                        <ColumnDefinition Width="Auto"/> <!-- Add Tab -->
                        <ColumnDefinition Width="Auto"/> <!-- Settings -->
                    </Grid.ColumnDefinitions>

                    <!-- History Toggle -->
                    <Button Grid.Column="0"
                            Content="☰"
                            Style="{StaticResource TechButtonStyle}"
                            Command="{Binding ToggleSidebarCommand}"
                            Width="34" Height="30"
                            FontSize="14"
                            Margin="0,0,10,0"
                            ToolTip="历史记录"/>

                    <!-- Notification Center Toggle -->
                    <Button Grid.Column="1"
                            Style="{StaticResource TechButtonStyle}"
                            Command="{Binding ToggleNotificationCenterCommand}"
                            Width="34" Height="30"
                            FontSize="14"
                            Margin="0,0,10,0"
                            ToolTip="通知中心">
                        <Grid>
                            <TextBlock Text="🔔" FontSize="14"/>
                            <!-- 未读通知徽章 -->
                            <Border x:Name="NotificationBadge"
                                    Visibility="{Binding UnreadNotificationCount, Converter={StaticResource IntToVisibilityConverter}}"
                                    Background="#FF2A6D"
                                    CornerRadius="7"
                                    MinWidth="14" Height="14"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Top"
                                    Margin="0,-5,-5,0"
                                    Padding="3,0">
                                <TextBlock Text="{Binding UnreadNotificationCount}"
                                           Foreground="White"
                                           FontSize="9"
                                           FontWeight="Bold"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"/>
                            </Border>
                        </Grid>
                    </Button>

                    <!-- Spacer -->
                    <Border Grid.Column="2" Grid.ColumnSpan="4"/>

                    <!-- New Tab Button -->
                    <Button Grid.Column="6"
                            Style="{StaticResource TechPrimaryButtonStyle}"
                            Click="NewTabButton_Click"
                            Height="30"
                            Padding="14,0"
                            Margin="0,0,10,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="+" FontSize="14" FontWeight="Bold" VerticalAlignment="Center"/>
                            <TextBlock Text=" NEW" FontSize="11" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <!-- Settings -->
                    <hc:SplitButton Grid.Column="7"
                                    Content="⚙"
                                    Background="Transparent"
                                    BorderBrush="#2A2A40"
                                    Foreground="{StaticResource CyberTextDimBrush}"
                                    FontSize="14"
                                    Height="30">
                        <hc:SplitButton.DropDownContent>
                            <Menu Background="#0C0C14" BorderThickness="0">
                                <Menu.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel/>
                                    </ItemsPanelTemplate>
                                </Menu.ItemsPanel>
                                <MenuItem Header="导入配置" Command="{Binding ImportConfigCommand}"/>
                                <MenuItem Header="导出配置" Command="{Binding ExportConfigCommand}"/>
                                <Separator/>
                                <MenuItem Header="终端 Shell">
                                    <MenuItem Header="PowerShell (推荐)" Click="ShellPowerShell_Click"
                                              IsCheckable="True" IsChecked="{Binding ShellType, Converter={StaticResource ShellTypeToCheckedConverter}, ConverterParameter=powershell}"/>
                                    <MenuItem Header="CMD" Click="ShellCmd_Click"
                                              IsCheckable="True" IsChecked="{Binding ShellType, Converter={StaticResource ShellTypeToCheckedConverter}, ConverterParameter=cmd}"/>
                                </MenuItem>
                                <Separator/>
                                <MenuItem Header="Hook 通知配置" Click="HookConfigMenuItem_Click"/>
                                <Separator/>
                                <MenuItem Header="帮助指南" Click="HelpMenuItem_Click"/>
                                <MenuItem Header="关于" Click="AboutMenuItem_Click"/>
                            </Menu>
                        </hc:SplitButton.DropDownContent>
                    </hc:SplitButton>
                </Grid>
            </Border>

            <!-- Row 3: Terminal Content Area -->
            <Border Grid.Row="3"
                    Margin="10,10,10,10"
                    Background="#000000"
                    BorderThickness="1"
                    CornerRadius="6"
                    ClipToBounds="True">
                <Border.BorderBrush>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                        <GradientStop Color="#2500D4FF" Offset="0"/>
                        <GradientStop Color="#25BD00FF" Offset="1"/>
                    </LinearGradientBrush>
                </Border.BorderBrush>

                <Grid>
                    <!-- Terminal WebView (底层) -->
                    <!-- 当任意 Drawer 打开时隐藏 WebView2，解决 Airspace 问题（WebView2 硬件加速渲染层覆盖 WPF 元素） -->
                    <ContentControl Content="{Binding SelectedTab.WebView}">
                        <ContentControl.Visibility>
                            <MultiBinding Converter="{StaticResource AnyBoolToCollapsedConverter}">
                                <Binding Path="IsHistoryOpen"/>
                                <Binding Path="IsNotificationCenterOpen"/>
                                <Binding Path="IsSettingsOpen"/>
                            </MultiBinding>
                        </ContentControl.Visibility>
                    </ContentControl>

                    <!-- Terminal Loading Animation Placeholder (顶层，WebView 加载前显示) -->
                    <Grid x:Name="TerminalLoadingPlaceholder"
                          IsHitTestVisible="False"
                          Background="#0C0C0C"
                          Panel.ZIndex="10"
                          Visibility="{Binding SelectedTab.WebView.CoreWebView2, Converter={StaticResource NullToVisibilityConverter}, FallbackValue=Visible}">
                        <!-- 科技网格背景 -->
                        <Border>
                            <Border.Background>
                                <DrawingBrush TileMode="Tile" Viewport="0,0,30,30" ViewportUnits="Absolute">
                                    <DrawingBrush.Drawing>
                                        <GeometryDrawing>
                                            <GeometryDrawing.Geometry>
                                                <GeometryGroup>
                                                    <LineGeometry StartPoint="0,0" EndPoint="30,0"/>
                                                    <LineGeometry StartPoint="0,0" EndPoint="0,30"/>
                                                </GeometryGroup>
                                            </GeometryDrawing.Geometry>
                                            <GeometryDrawing.Pen>
                                                <Pen Brush="#1500D4FF" Thickness="1"/>
                                            </GeometryDrawing.Pen>
                                        </GeometryDrawing>
                                    </DrawingBrush.Drawing>
                                </DrawingBrush>
                            </Border.Background>
                        </Border>

                        <!-- 中心加载动画 -->
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <!-- 旋转光环 -->
                            <Grid Width="60" Height="60" Margin="0,0,0,20">
                                <Ellipse Width="60" Height="60" StrokeThickness="2" Stroke="#1500D4FF"/>
                                <Ellipse Width="50" Height="50" StrokeThickness="2" Stroke="#1500D4FF"/>
                                <Ellipse x:Name="LoadingRing1" Width="60" Height="60" StrokeThickness="3"
                                         StrokeDashArray="1 3" RenderTransformOrigin="0.5,0.5">
                                    <Ellipse.Stroke>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                            <GradientStop Color="#00D4FF" Offset="0"/>
                                            <GradientStop Color="Transparent" Offset="0.5"/>
                                        </LinearGradientBrush>
                                    </Ellipse.Stroke>
                                    <Ellipse.RenderTransform>
                                        <RotateTransform x:Name="LoadingRing1Rotation"/>
                                    </Ellipse.RenderTransform>
                                </Ellipse>
                                <Ellipse x:Name="LoadingRing2" Width="46" Height="46" StrokeThickness="2"
                                         StrokeDashArray="2 4" RenderTransformOrigin="0.5,0.5">
                                    <Ellipse.Stroke>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                            <GradientStop Color="#BD00FF" Offset="0"/>
                                            <GradientStop Color="Transparent" Offset="0.5"/>
                                        </LinearGradientBrush>
                                    </Ellipse.Stroke>
                                    <Ellipse.RenderTransform>
                                        <RotateTransform x:Name="LoadingRing2Rotation"/>
                                    </Ellipse.RenderTransform>
                                </Ellipse>
                                <!-- 中心图标 -->
                                <TextBlock Text="◈" Foreground="#00D4FF" FontSize="20"
                                           HorizontalAlignment="Center" VerticalAlignment="Center">
                                    <TextBlock.Effect>
                                        <DropShadowEffect Color="#00D4FF" BlurRadius="10" ShadowDepth="0" Opacity="0.6"/>
                                    </TextBlock.Effect>
                                </TextBlock>
                            </Grid>

                            <!-- 状态文字 -->
                            <TextBlock x:Name="TerminalStatusText"
                                       Text="INITIALIZING TERMINAL"
                                       Foreground="#00D4FF"
                                       FontFamily="Consolas"
                                       FontSize="12"
                                       FontWeight="SemiBold"
                                       HorizontalAlignment="Center">
                                <TextBlock.Effect>
                                    <DropShadowEffect Color="#00D4FF" BlurRadius="8" ShadowDepth="0" Opacity="0.4"/>
                                </TextBlock.Effect>
                            </TextBlock>

                            <!-- 进度指示条 -->
                            <Border Width="120" Height="2" Background="#1A1A2A" CornerRadius="1" Margin="0,12,0,0">
                                <Border x:Name="TerminalProgressBar" Width="0" Height="2"
                                        Background="{StaticResource CyberBlueBrush}"
                                        CornerRadius="1" HorizontalAlignment="Left">
                                    <Border.Effect>
                                        <DropShadowEffect Color="#00D4FF" BlurRadius="6" ShadowDepth="0" Opacity="0.5"/>
                                    </Border.Effect>
                                </Border>
                            </Border>

                            <!-- 次要文字 -->
                            <TextBlock Text="// ESTABLISHING CONNECTION..."
                                       Foreground="#4A4A6A"
                                       FontFamily="Consolas"
                                       FontSize="10"
                                       HorizontalAlignment="Center"
                                       Margin="0,10,0,0"/>
                        </StackPanel>

                        <!-- 加载动画触发器 -->
                        <Grid.Triggers>
                            <EventTrigger RoutedEvent="Loaded">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <!-- 外环旋转 -->
                                        <DoubleAnimation Storyboard.TargetName="LoadingRing1Rotation"
                                                         Storyboard.TargetProperty="Angle"
                                                         From="0" To="360" Duration="0:0:2"
                                                         RepeatBehavior="Forever"/>
                                        <!-- 内环反向旋转 -->
                                        <DoubleAnimation Storyboard.TargetName="LoadingRing2Rotation"
                                                         Storyboard.TargetProperty="Angle"
                                                         From="360" To="0" Duration="0:0:1.5"
                                                         RepeatBehavior="Forever"/>
                                        <!-- 进度条动画 -->
                                        <DoubleAnimation Storyboard.TargetName="TerminalProgressBar"
                                                         Storyboard.TargetProperty="Width"
                                                         From="0" To="120" Duration="0:0:2"
                                                         RepeatBehavior="Forever"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                        </Grid.Triggers>
                    </Grid>
                </Grid>
            </Border>

            <!-- History Drawer -->
            <hc:Drawer Name="HistoryDrawer"
                       Grid.Row="1"
                       Grid.RowSpan="3"
                       ShowMode="Push"
                       IsOpen="{Binding IsHistoryOpen}"
                       Dock="Left">
                <Border Width="280"
                        Background="{StaticResource CyberDarkBrush}"
                        BorderBrush="#1A1A2A"
                        BorderThickness="0,0,1,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Margin="12">
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <TextBlock Text="◈" Foreground="{StaticResource CyberBlueBrush}" FontSize="12"/>
                                <TextBlock Text=" HISTORY" Foreground="{StaticResource CyberBlueBrush}" FontWeight="Bold" FontSize="13" Margin="4,0,0,0"/>
                            </StackPanel>
                            <hc:SearchBar Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                          Style="{StaticResource SearchBarPlus}"
                                          hc:InfoElement.Placeholder="搜索..."
                                          Background="#08080F"
                                          BorderThickness="1"
                                          BorderBrush="#1A1A2A"/>
                        </StackPanel>

                        <ListBox Grid.Row="1"
                                 ItemsSource="{Binding FilteredHistory}"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 Margin="8,0,8,8"
                                 MouseDoubleClick="HistoryListBox_MouseDoubleClick">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#0C0C14"
                                            CornerRadius="4"
                                            Padding="10,8"
                                            Margin="0,0,0,6"
                                            BorderBrush="#1A1A2A"
                                            BorderThickness="1"
                                            Cursor="Hand">
                                        <StackPanel>
                                            <TextBlock Text="{Binding Name}"
                                                       Foreground="{StaticResource CyberTextBrush}"
                                                       FontWeight="SemiBold"
                                                       FontSize="12"
                                                       TextTrimming="CharacterEllipsis"/>
                                            <TextBlock Text="{Binding WorkingDirectory}"
                                                       FontSize="10"
                                                       Foreground="{StaticResource CyberTextDimBrush}"
                                                       Margin="0,3,0,0"
                                                       TextTrimming="CharacterEllipsis"/>
                                            <Border Background="#1000D4FF"
                                                    CornerRadius="2"
                                                    HorizontalAlignment="Left"
                                                    Margin="0,5,0,0"
                                                    Padding="6,2"
                                                    Visibility="{Binding Note, Converter={StaticResource String2VisibilityConverter}}">
                                                <TextBlock Text="{Binding Note}"
                                                           FontSize="9"
                                                           Foreground="{StaticResource CyberBlueBrush}"
                                                           TextTrimming="CharacterEllipsis"/>
                                            </Border>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Border>
            </hc:Drawer>

            <!-- Notification Center Drawer -->
            <hc:Drawer Name="NotificationDrawer"
                       Grid.Row="1"
                       Grid.RowSpan="3"
                       ShowMode="Cover"
                       IsOpen="{Binding IsNotificationCenterOpen}"
                       Dock="Right">
                <Border Width="320"
                        Background="#0A0A12"
                        BorderBrush="#1A1A2A"
                        BorderThickness="1,0,0,0"
                        DataContext="{Binding Data, Source={StaticResource ViewModelProxy}}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Header -->
                        <Border Grid.Row="0" BorderBrush="#1A1A2A" BorderThickness="0,0,0,1" Padding="16,12">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0" Orientation="Horizontal">
                                    <TextBlock Text="🔔" FontSize="16" VerticalAlignment="Center"/>
                                    <TextBlock Text=" 通知中心" Foreground="White" FontWeight="Bold" FontSize="14" VerticalAlignment="Center" Margin="6,0,0,0"/>
                                    <Border Background="#00d4ff20" CornerRadius="8" Padding="6,2" Margin="8,0,0,0"
                                            Visibility="{Binding UnreadNotificationCount, Converter={StaticResource IntToVisibilityConverter}}">
                                        <TextBlock Text="{Binding UnreadNotificationCount}" Foreground="#00d4ff" FontSize="10" FontWeight="Bold"/>
                                    </Border>
                                </StackPanel>

                                <Button Grid.Column="1"
                                        Content="全部已读"
                                        Style="{StaticResource TechButtonStyle}"
                                        Command="{Binding MarkAllNotificationsReadCommand}"
                                        FontSize="10"
                                        Padding="8,4"
                                        Margin="0,0,8,0"/>

                                <Button Grid.Column="2"
                                        Content="清空"
                                        Style="{StaticResource TechButtonStyle}"
                                        Command="{Binding ClearAllNotificationsCommand}"
                                        FontSize="10"
                                        Padding="8,4"
                                        Foreground="#FF2A6D"/>
                            </Grid>
                        </Border>

                        <!-- Notification List -->
                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding Notifications}" Margin="8">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#0C0C16"
                                                CornerRadius="6"
                                                Padding="12,10"
                                                Margin="0,0,0,8"
                                                BorderThickness="1"
                                                Cursor="Hand">
                                            <Border.BorderBrush>
                                                <SolidColorBrush Color="#1a1a2a"/>
                                            </Border.BorderBrush>
                                            <Border.InputBindings>
                                                <MouseBinding MouseAction="LeftClick"
                                                              Command="{Binding DataContext.OpenNotificationCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                              CommandParameter="{Binding}"/>
                                            </Border.InputBindings>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- Icon -->
                                                <TextBlock Grid.Column="0" Text="◈" FontSize="20" Foreground="#00d4ff" VerticalAlignment="Top" Margin="0,2,10,0">
                                                    <TextBlock.Effect>
                                                        <DropShadowEffect Color="#00d4ff" BlurRadius="8" ShadowDepth="0" Opacity="0.6"/>
                                                    </TextBlock.Effect>
                                                </TextBlock>

                                                <!-- Content -->
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="{Binding TabName}" Foreground="#00d4ff" FontSize="11" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding Title}" Foreground="White" FontSize="12" FontWeight="Medium" Margin="0,2,0,0"/>
                                                    <TextBlock Text="{Binding Message}" Foreground="#6a6a8a" FontSize="10" Margin="0,2,0,0" TextWrapping="Wrap"/>
                                                    <TextBlock Text="{Binding RelativeTime}" Foreground="#4a4a6a" FontSize="9" Margin="0,4,0,0"/>
                                                </StackPanel>

                                                <!-- Close Button -->
                                                <Button Grid.Column="2" Content="✕"
                                                        Width="20" Height="20" FontSize="9"
                                                        Background="Transparent" Foreground="#4a4a6a"
                                                        BorderThickness="0" Cursor="Hand"
                                                        VerticalAlignment="Top"
                                                        Command="{Binding DataContext.RemoveNotificationCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                        CommandParameter="{Binding}">
                                                    <Button.Style>
                                                        <Style TargetType="Button">
                                                            <Setter Property="Template">
                                                                <Setter.Value>
                                                                    <ControlTemplate TargetType="Button">
                                                                        <Border Background="{TemplateBinding Background}" CornerRadius="3">
                                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                        </Border>
                                                                    </ControlTemplate>
                                                                </Setter.Value>
                                                            </Setter>
                                                            <Style.Triggers>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter Property="Background" Value="#ff2a6d30"/>
                                                                    <Setter Property="Foreground" Value="#ff2a6d"/>
                                                                </Trigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                </Button>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <!-- Empty State -->
                        <StackPanel Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center"
                                    Visibility="{Binding Notifications.Count, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=Invert}">
                            <TextBlock Text="🔔" FontSize="32" HorizontalAlignment="Center" Opacity="0.3"/>
                            <TextBlock Text="暂无通知" Foreground="#4a4a6a" FontSize="12" HorizontalAlignment="Center" Margin="0,8,0,0"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </hc:Drawer>

            <!-- Settings Center Drawer -->
            <hc:Drawer Name="SettingsDrawer"
                       Grid.Row="0"
                       Grid.RowSpan="4"
                       Panel.ZIndex="100"
                       ShowMode="Cover"
                       IsOpen="{Binding IsSettingsOpen}"
                       Dock="Right">
                <Border Width="360"
                        Background="#0A0A12"
                        BorderBrush="#1A1A2A"
                        BorderThickness="1,0,0,0"
                        DataContext="{Binding Data, Source={StaticResource ViewModelProxy}}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Header -->
                        <Border Grid.Row="0" BorderBrush="#1A1A2A" BorderThickness="0,0,0,1" Padding="16,12">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0" Orientation="Horizontal">
                                    <TextBlock Text="&#xE713;" FontFamily="Segoe MDL2 Assets" FontSize="16" Foreground="#00d4ff" VerticalAlignment="Center"/>
                                    <TextBlock Text=" 设置中心" Foreground="White" FontWeight="Bold" FontSize="14" VerticalAlignment="Center" Margin="8,0,0,0"/>
                                </StackPanel>

                                <Button Grid.Column="1"
                                        Content="✕"
                                        Style="{StaticResource TechButtonStyle}"
                                        Command="{Binding CloseSettingsCommand}"
                                        FontSize="12"
                                        Padding="8,4"
                                        Foreground="#6a6a8a"/>
                            </Grid>
                        </Border>

                        <!-- Settings Content -->
                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="16">
                            <StackPanel>
                                <!-- Window Settings Section -->
                                <TextBlock Text="窗口设置" Foreground="#00d4ff" FontSize="12" FontWeight="SemiBold" Margin="0,0,0,12"/>

                                <!-- Start Full Screen -->
                                <Border Background="#0C0C16" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="启动时全屏" Foreground="White" FontSize="13"/>
                                            <TextBlock Text="覆盖任务栏，沉浸式体验" Foreground="#6a6a8a" FontSize="10" Margin="0,4,0,0"/>
                                        </StackPanel>
                                        <ToggleButton Grid.Column="1"
                                                      IsChecked="{Binding StartFullScreen}"
                                                      Style="{StaticResource CyberToggleSwitchStyle}"
                                                      VerticalAlignment="Center"/>
                                    </Grid>
                                </Border>

                                <!-- Start Maximized (shown when not full screen) -->
                                <Border Background="#0C0C16" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="启动时最大化" Foreground="White" FontSize="13"/>
                                            <TextBlock Text="窗口自动最大化，但保留任务栏" Foreground="#6a6a8a" FontSize="10" Margin="0,4,0,0"/>
                                        </StackPanel>
                                        <ToggleButton Grid.Column="1"
                                                      IsChecked="{Binding StartMaximized}"
                                                      Style="{StaticResource CyberToggleSwitchStyle}"
                                                      VerticalAlignment="Center"/>
                                    </Grid>
                                </Border>

                                <!-- Divider -->
                                <Border Height="1" Background="#1A1A2A" Margin="0,12,0,16"/>

                                <!-- Notification Settings Section -->
                                <TextBlock Text="通知设置" Foreground="#00d4ff" FontSize="12" FontWeight="SemiBold" Margin="0,0,0,12"/>

                                <!-- Enable Desktop Notifications -->
                                <Border Background="#0C0C16" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="桌面通知" Foreground="White" FontSize="13"/>
                                            <TextBlock Text="任务完成时显示悬浮通知" Foreground="#6a6a8a" FontSize="10" Margin="0,4,0,0"/>
                                        </StackPanel>
                                        <ToggleButton Grid.Column="1"
                                                      IsChecked="{Binding EnableDesktopNotifications}"
                                                      Style="{StaticResource CyberToggleSwitchStyle}"
                                                      VerticalAlignment="Center"/>
                                    </Grid>
                                </Border>

                                <!-- Hook Config Section -->
                                <Border Background="#0C0C16" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Row="0" Grid.Column="0">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="Claude Hook 配置" Foreground="White" FontSize="13"/>
                                                <Ellipse Width="8" Height="8" Margin="8,0,0,0" VerticalAlignment="Center">
                                                    <Ellipse.Style>
                                                        <Style TargetType="Ellipse">
                                                            <Setter Property="Fill" Value="#ff6b6b"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsHookConfigured}" Value="True">
                                                                    <Setter Property="Fill" Value="#16c60c"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Ellipse.Style>
                                                </Ellipse>
                                            </StackPanel>
                                            <TextBlock Text="{Binding HookStatusText}" Foreground="#6a6a8a" FontSize="10" Margin="0,4,0,0" TextWrapping="Wrap"/>
                                        </StackPanel>
                                        <Button Grid.Row="0" Grid.Column="1"
                                                Command="{Binding ConfigureHookCommand}"
                                                Style="{StaticResource TechPrimaryButtonStyle}"
                                                Padding="12,6" FontSize="11"
                                                VerticalAlignment="Top">
                                            <Button.Content>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="◈" Margin="0,0,6,0"
                                                               Visibility="{Binding IsConfiguringHook, Converter={StaticResource Boolean2VisibilityConverter}}">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsConfiguringHook}" Value="True">
                                                                        <DataTrigger.EnterActions>
                                                                            <BeginStoryboard>
                                                                                <Storyboard RepeatBehavior="Forever">
                                                                                    <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                                                                                     From="0" To="360" Duration="0:0:1"/>
                                                                                </Storyboard>
                                                                            </BeginStoryboard>
                                                                        </DataTrigger.EnterActions>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                        <TextBlock.RenderTransform>
                                                            <RotateTransform CenterX="5" CenterY="7"/>
                                                        </TextBlock.RenderTransform>
                                                    </TextBlock>
                                                    <TextBlock>
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Text" Value="一键配置"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsConfiguringHook}" Value="True">
                                                                        <Setter Property="Text" Value="配置中..."/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding IsHookConfigured}" Value="True">
                                                                        <Setter Property="Text" Value="重新配置"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </StackPanel>
                                            </Button.Content>
                                        </Button>
                                        <TextBlock Grid.Row="1" Grid.ColumnSpan="2"
                                                   Text="💡 配置后，Claude Code 任务完成时将自动发送通知"
                                                   Foreground="#4a4a6a"
                                                   FontSize="10"
                                                   Margin="0,8,0,0"/>
                                    </Grid>
                                </Border>

                                <!-- Divider -->
                                <Border Height="1" Background="#1A1A2A" Margin="0,12,0,16"/>

                                <!-- Hotkey Settings Section -->
                                <TextBlock Text="快捷键设置" Foreground="#00d4ff" FontSize="12" FontWeight="SemiBold" Margin="0,0,0,12"/>

                                <!-- Status Bar Hotkey -->
                                <Border Background="#0C0C16" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Row="0" Grid.Column="0">
                                            <TextBlock Text="悬浮状态栏快捷键" Foreground="White" FontSize="13"/>
                                            <TextBlock Text="快速查看所有终端状态" Foreground="#6a6a8a" FontSize="10" Margin="0,4,0,0"/>
                                        </StackPanel>
                                        <Border Grid.Row="0" Grid.Column="1"
                                                Background="#14141F"
                                                BorderBrush="#00d4ff40"
                                                BorderThickness="1"
                                                CornerRadius="4"
                                                Padding="12,6"
                                                VerticalAlignment="Center">
                                            <TextBlock Text="Ctrl+Shift+Space"
                                                       Foreground="#00d4ff"
                                                       FontFamily="Consolas"
                                                       FontSize="11"
                                                       FontWeight="SemiBold"/>
                                        </Border>
                                        <TextBlock Grid.Row="1" Grid.ColumnSpan="2"
                                                   Text="💡 按下快捷键可快速唤起/隐藏悬浮状态栏"
                                                   Foreground="#4a4a6a"
                                                   FontSize="10"
                                                   Margin="0,8,0,0"/>
                                    </Grid>
                                </Border>

                                <!-- Divider -->
                                <Border Height="1" Background="#1A1A2A" Margin="0,12,0,16"/>

                                <!-- System Settings Section -->
                                <TextBlock Text="系统设置" Foreground="#00d4ff" FontSize="12" FontWeight="SemiBold" Margin="0,0,0,12"/>

                                <!-- Minimize to Tray -->
                                <Border Background="#0C0C16" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="关闭时最小化到托盘" Foreground="White" FontSize="13"/>
                                            <TextBlock Text="点击关闭按钮时隐藏而非退出" Foreground="#6a6a8a" FontSize="10" Margin="0,4,0,0"/>
                                        </StackPanel>
                                        <ToggleButton Grid.Column="1"
                                                      IsChecked="{Binding MinimizeToTrayOnClose}"
                                                      Style="{StaticResource CyberToggleSwitchStyle}"
                                                      VerticalAlignment="Center"/>
                                    </Grid>
                                </Border>

                                <!-- Divider -->
                                <Border Height="1" Background="#1A1A2A" Margin="0,12,0,16"/>

                                <!-- Remote Control Section -->
                                <TextBlock Text="远程控制" Foreground="#00d4ff" FontSize="12" FontWeight="SemiBold" Margin="0,0,0,12"/>

                                <!-- Enable Remote Control -->
                                <Border Background="#0C0C16" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="启用远程控制" Foreground="White" FontSize="13"/>
                                            <TextBlock Text="通过手机浏览器访问终端" Foreground="#6a6a8a" FontSize="10" Margin="0,4,0,0"/>
                                        </StackPanel>
                                        <ToggleButton Grid.Column="1"
                                                      IsChecked="{Binding RemoteControlEnabled}"
                                                      Style="{StaticResource CyberToggleSwitchStyle}"
                                                      VerticalAlignment="Center"/>
                                    </Grid>
                                </Border>

                                <!-- Remote Control Details (shown when enabled) -->
                                <StackPanel Visibility="{Binding RemoteControlEnabled, Converter={StaticResource Boolean2VisibilityConverter}}">
                                    <!-- Local URL -->
                                    <Border Background="#0C0C16" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                        <StackPanel>
                                            <TextBlock Text="本地地址" Foreground="#6a6a8a" FontSize="10" Margin="0,0,0,4"/>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="{Binding RemoteLocalUrl}" Foreground="#00d4ff" FontSize="11" FontFamily="Consolas" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                                                <Button Grid.Column="1" Content="复制" Style="{StaticResource TechButtonStyle}" Command="{Binding CopyRemoteUrlCommand}" Padding="8,4" FontSize="10" Margin="8,0,0,0"/>
                                            </Grid>
                                        </StackPanel>
                                    </Border>

                                    <!-- Access Token -->
                                    <Border Background="#0C0C16" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                        <StackPanel>
                                            <TextBlock Text="访问码" Foreground="#6a6a8a" FontSize="10" Margin="0,0,0,4"/>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <Border Grid.Column="0" Background="#14141F" BorderBrush="#00d4ff40" BorderThickness="1" CornerRadius="4" Padding="12,6">
                                                    <TextBlock Text="{Binding RemoteAccessToken}" Foreground="#00d4ff" FontFamily="Consolas" FontSize="18" FontWeight="Bold"/>
                                                </Border>
                                                <Button Grid.Column="1" Content="刷新" Style="{StaticResource TechButtonStyle}" Command="{Binding RefreshAccessTokenCommand}" Padding="8,4" FontSize="10" Margin="8,0,0,0"/>
                                            </Grid>
                                        </StackPanel>
                                    </Border>

                                    <!-- Connection Count -->
                                    <Border Background="#0C0C16" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="当前连接数" Foreground="White" FontSize="13"/>
                                            <TextBlock Grid.Column="1" Text="{Binding RemoteConnectionCount}" Foreground="#00d4ff" FontSize="13" FontWeight="Bold"/>
                                        </Grid>
                                    </Border>

                                    <!-- Cloudflare Tunnel -->
                                    <Border Background="#0C0C16" CornerRadius="6" Padding="12" Margin="0,0,0,8">
                                        <StackPanel>
                                            <Grid Margin="0,0,0,8">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="公网访问 (Cloudflare Tunnel)" Foreground="White" FontSize="13"/>
                                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                        <Ellipse Width="8" Height="8" Margin="0,0,6,0">
                                                            <Ellipse.Style>
                                                                <Style TargetType="Ellipse">
                                                                    <Setter Property="Fill" Value="#4a4a6a"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsTunnelRunning}" Value="True">
                                                                            <Setter Property="Fill" Value="#16c60c"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Ellipse.Style>
                                                        </Ellipse>
                                                        <TextBlock Text="{Binding TunnelStatusText}" Foreground="#6a6a8a" FontSize="10"/>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Grid>

                                            <!-- Public URL (shown when tunnel running) -->
                                            <Border Background="#14141F" CornerRadius="4" Padding="8" Margin="0,0,0,8"
                                                    Visibility="{Binding IsTunnelRunning, Converter={StaticResource Boolean2VisibilityConverter}}">
                                                <TextBox Text="{Binding RemotePublicUrl, Mode=OneWay}"
                                                         Foreground="#16c60c" FontSize="10" FontFamily="Consolas"
                                                         TextWrapping="Wrap" IsReadOnly="True"
                                                         Background="Transparent" BorderThickness="0"
                                                         Cursor="IBeam"/>
                                            </Border>

                                            <!-- Tunnel Buttons -->
                                            <StackPanel Orientation="Horizontal">
                                                <Button Content="启动隧道" Style="{StaticResource TechPrimaryButtonStyle}" Command="{Binding StartTunnelCommand}" Padding="12,6" FontSize="11" Margin="0,0,8,0">
                                                    <Button.Visibility>
                                                        <MultiBinding Converter="{StaticResource AnyBoolToCollapsedConverter}">
                                                            <Binding Path="IsTunnelRunning"/>
                                                        </MultiBinding>
                                                    </Button.Visibility>
                                                </Button>
                                                <Button Content="停止隧道" Style="{StaticResource TechButtonStyle}" Command="{Binding StopTunnelCommand}" Padding="12,6" FontSize="11" Margin="0,0,8,0"
                                                        Visibility="{Binding IsTunnelRunning, Converter={StaticResource Boolean2VisibilityConverter}}"/>

                                                <!-- Install cloudflared button with loading animation -->
                                                <Button Command="{Binding InstallCloudflaredCommand}" Padding="12,6" FontSize="11" Foreground="#c19c00">
                                                    <Button.Style>
                                                        <Style TargetType="Button" BasedOn="{StaticResource TechButtonStyle}">
                                                            <Setter Property="Cursor" Value="Hand"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsInstallingCloudflared}" Value="True">
                                                                    <Setter Property="Cursor" Value="Wait"/>
                                                                    <Setter Property="IsEnabled" Value="False"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                    <Button.Content>
                                                        <StackPanel Orientation="Horizontal">
                                                            <!-- Loading spinner (visible when installing) -->
                                                            <TextBlock Text="◈" Margin="0,0,6,0"
                                                                       Visibility="{Binding IsInstallingCloudflared, Converter={StaticResource Boolean2VisibilityConverter}}">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding IsInstallingCloudflared}" Value="True">
                                                                                <DataTrigger.EnterActions>
                                                                                    <BeginStoryboard>
                                                                                        <Storyboard RepeatBehavior="Forever">
                                                                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                                                                                             From="0" To="360" Duration="0:0:1"/>
                                                                                        </Storyboard>
                                                                                    </BeginStoryboard>
                                                                                </DataTrigger.EnterActions>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                                <TextBlock.RenderTransform>
                                                                    <RotateTransform CenterX="5" CenterY="7"/>
                                                                </TextBlock.RenderTransform>
                                                            </TextBlock>
                                                            <!-- Button text -->
                                                            <TextBlock>
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Text" Value="安装 cloudflared"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding IsInstallingCloudflared}" Value="True">
                                                                                <Setter Property="Text" Value="安装中..."/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                        </StackPanel>
                                                    </Button.Content>
                                                    <Button.Visibility>
                                                        <MultiBinding Converter="{StaticResource AnyBoolToCollapsedConverter}">
                                                            <Binding Path="IsCloudflaredInstalled"/>
                                                        </MultiBinding>
                                                    </Button.Visibility>
                                                </Button>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>

                                <!-- Version Info -->
                                <Border Height="1" Background="#1A1A2A" Margin="0,20,0,16"/>
                                <StackPanel HorizontalAlignment="Center" Margin="0,10,0,20">
                                    <TextBlock Text="◈ QIANTERMINALCODE" Foreground="#3a3a5a" FontSize="11" FontFamily="Consolas" HorizontalAlignment="Center"/>
                                    <TextBlock Text="Version 1.0.0" Foreground="#2a2a4a" FontSize="10" HorizontalAlignment="Center" Margin="0,4,0,0"/>
                                </StackPanel>
                            </StackPanel>
                        </ScrollViewer>
                    </Grid>
                </Border>
            </hc:Drawer>
            </Grid>
        </Grid>
    </Border>
</Window>
