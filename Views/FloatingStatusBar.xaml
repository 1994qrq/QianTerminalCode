<Window x:Class="CodeBridge.Views.FloatingStatusBar"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:CodeBridge.Converters"
        mc:Ignorable="d"
        Title="FloatingStatusBar"
        Width="520"
        Height="Auto"
        MaxHeight="480"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        ResizeMode="NoResize"
        ShowInTaskbar="False"
        Topmost="True"
        Focusable="True"
        WindowStartupLocation="Manual">

    <Window.Resources>
        <!-- Converters -->
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
        <converters:BoolToStatusTextConverter x:Key="BoolToStatusTextConverter"/>

        <!-- Colors -->
        <Color x:Key="CyberBlack">#05050A</Color>
        <Color x:Key="CyberDark">#0D0D14</Color>
        <Color x:Key="CyberSurface">#14141F</Color>
        <Color x:Key="CyberBlue">#00D4FF</Color>
        <Color x:Key="CyberPurple">#BD00FF</Color>
        <Color x:Key="CyberPink">#FF0080</Color>
        <Color x:Key="CyberGreen">#00FF9D</Color>
        <Color x:Key="CyberText">#E0E0FF</Color>
        <Color x:Key="CyberTextDim">#6A6A8A</Color>

        <!-- Brushes -->
        <SolidColorBrush x:Key="CyberBlackBrush" Color="{StaticResource CyberBlack}"/>
        <SolidColorBrush x:Key="CyberDarkBrush" Color="{StaticResource CyberDark}"/>
        <SolidColorBrush x:Key="CyberSurfaceBrush" Color="{StaticResource CyberSurface}"/>
        <SolidColorBrush x:Key="CyberBlueBrush" Color="{StaticResource CyberBlue}"/>
        <SolidColorBrush x:Key="CyberPurpleBrush" Color="{StaticResource CyberPurple}"/>
        <SolidColorBrush x:Key="CyberGreenBrush" Color="{StaticResource CyberGreen}"/>
        <SolidColorBrush x:Key="CyberTextBrush" Color="{StaticResource CyberText}"/>
        <SolidColorBrush x:Key="CyberTextDimBrush" Color="{StaticResource CyberTextDim}"/>

        <!-- Neon Gradient Border -->
        <LinearGradientBrush x:Key="NeonBorderBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="{StaticResource CyberBlue}" Offset="0"/>
            <GradientStop Color="{StaticResource CyberPurple}" Offset="0.5"/>
            <GradientStop Color="{StaticResource CyberPink}" Offset="1"/>
        </LinearGradientBrush>

        <!-- Window Background -->
        <LinearGradientBrush x:Key="WindowBackgroundBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#E8080810" Offset="0"/>
            <GradientStop Color="#F00A0A14" Offset="0.5"/>
            <GradientStop Color="#E80C0C18" Offset="1"/>
        </LinearGradientBrush>

        <!-- Pulse Animation for Working Status -->
        <Storyboard x:Key="PulseAnimation" RepeatBehavior="Forever">
            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                             From="1" To="0.4" Duration="0:0:0.8"
                             AutoReverse="True"
                             EasingFunction="{StaticResource {x:Static SystemParameters.MenuAnimationKey}}"/>
        </Storyboard>

        <!-- Filter Button Style -->
        <Style x:Key="FilterButtonStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#2A2A40"/>
            <Setter Property="Foreground" Value="{StaticResource CyberTextDimBrush}"/>
            <Setter Property="FontFamily" Value="Consolas"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Padding" Value="12,4"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#15FFFFFF"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="#4A4A6A"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#2000D4FF"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource CyberBlueBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource CyberBlueBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Tab Item Style -->
        <Style x:Key="TabItemButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="Transparent"
                                BorderThickness="1"
                                CornerRadius="6"
                                Padding="12,10">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#15FFFFFF"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="#3000D4FF"/>
                                <Setter TargetName="border" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect Color="{StaticResource CyberBlue}" BlurRadius="10" ShadowDepth="0" Opacity="0.3"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <!-- Main Container - Capsule Shape -->
    <Border x:Name="MainBorder"
            Background="{StaticResource WindowBackgroundBrush}"
            BorderBrush="{StaticResource NeonBorderBrush}"
            BorderThickness="1.5"
            CornerRadius="20"
            Margin="10">
        <Border.Effect>
            <DropShadowEffect Color="{StaticResource CyberPurple}" BlurRadius="30" ShadowDepth="0" Opacity="0.5"/>
        </Border.Effect>

        <!-- Blur Effect Background -->
        <Border.OpacityMask>
            <VisualBrush>
                <VisualBrush.Visual>
                    <Border Background="White" CornerRadius="20"
                            Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Border}}"
                            Height="{Binding ActualHeight, RelativeSource={RelativeSource AncestorType=Border}}"/>
                </VisualBrush.Visual>
            </VisualBrush>
        </Border.OpacityMask>

        <Grid>
            <Grid.RowDefinitions>
                <!-- Header -->
                <RowDefinition Height="44"/>
                <!-- Separator -->
                <RowDefinition Height="1"/>
                <!-- Content -->
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <Grid Grid.Row="0" Margin="16,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Title -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <!-- Icon -->
                    <TextBlock Text="&#x25C8;"
                               Foreground="{StaticResource CyberBlueBrush}"
                               FontSize="16"
                               VerticalAlignment="Center">
                        <TextBlock.Effect>
                            <DropShadowEffect Color="{StaticResource CyberBlue}" BlurRadius="10" ShadowDepth="0" Opacity="0.8"/>
                        </TextBlock.Effect>
                    </TextBlock>
                    <!-- Title Text -->
                    <TextBlock Text="飞跃侠·CodeBridge"
                               Foreground="{StaticResource CyberTextBrush}"
                               FontFamily="Microsoft YaHei UI"
                               FontSize="13"
                               FontWeight="Bold"
                               VerticalAlignment="Center"
                               Margin="10,0,0,0"/>
                </StackPanel>

                <!-- Filter Buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <ToggleButton x:Name="FilterWorkingButton"
                                  Content="工作中"
                                  Style="{StaticResource FilterButtonStyle}"
                                  IsChecked="False"
                                  Checked="FilterButton_Changed"
                                  Unchecked="FilterButton_Changed"
                                  Margin="0,0,8,0"/>
                    <ToggleButton x:Name="FilterIdleButton"
                                  Content="待机中"
                                  Style="{StaticResource FilterButtonStyle}"
                                  IsChecked="False"
                                  Checked="FilterButton_Changed"
                                  Unchecked="FilterButton_Changed"/>

                    <!-- 分隔线 -->
                    <Border Width="1" Height="16" Background="#3A3A5A" Margin="12,0"/>

                    <!-- 关闭按钮 -->
                    <Button x:Name="CloseButton"
                            Click="CloseButton_Click"
                            ToolTip="关闭 (ESC)"
                            Cursor="Hand"
                            Background="Transparent"
                            BorderThickness="0"
                            Padding="6,4">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border x:Name="bd" Background="Transparent" CornerRadius="4" Padding="{TemplateBinding Padding}">
                                    <TextBlock Text="✕" FontSize="12" Foreground="#6A6A8A" VerticalAlignment="Center"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="bd" Property="Background" Value="#30FF6B6B"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>
                </StackPanel>
            </Grid>

            <!-- Separator -->
            <Border Grid.Row="1">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                        <GradientStop Color="Transparent" Offset="0"/>
                        <GradientStop Color="#3000D4FF" Offset="0.2"/>
                        <GradientStop Color="#30BD00FF" Offset="0.8"/>
                        <GradientStop Color="Transparent" Offset="1"/>
                    </LinearGradientBrush>
                </Border.Background>
            </Border>

            <!-- Tab List -->
            <ScrollViewer Grid.Row="2"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          Margin="8,8,8,12">
                <ScrollViewer.Resources>
                    <Style TargetType="ScrollBar">
                        <Setter Property="Width" Value="6"/>
                        <Setter Property="Background" Value="Transparent"/>
                    </Style>
                </ScrollViewer.Resources>

                <ItemsControl x:Name="TabItemsControl">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <!-- 双列布局 -->
                            <UniformGrid Columns="2"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <!-- 紧凑标签项 -->
                            <Button Style="{StaticResource TabItemButtonStyle}"
                                    Click="TabItem_Click"
                                    Tag="{Binding}"
                                    Margin="2">
                                <Grid Height="24">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="14"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Status Indicator -->
                                    <Grid Grid.Column="0" VerticalAlignment="Center">
                                        <!-- Working: Green Pulsing Dot -->
                                        <Ellipse x:Name="WorkingDot"
                                                 Width="6" Height="6"
                                                 Fill="{StaticResource CyberGreenBrush}"
                                                 Visibility="{Binding IsTaskRunning, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <Ellipse.Effect>
                                                <DropShadowEffect Color="{StaticResource CyberGreen}" BlurRadius="6" ShadowDepth="0" Opacity="0.8"/>
                                            </Ellipse.Effect>
                                            <Ellipse.Triggers>
                                                <EventTrigger RoutedEvent="Loaded">
                                                    <BeginStoryboard>
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="1" To="0.4" Duration="0:0:0.8"
                                                                             AutoReverse="True"/>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </EventTrigger>
                                            </Ellipse.Triggers>
                                        </Ellipse>
                                        <!-- Idle: Gray Hollow Circle -->
                                        <Ellipse Width="6" Height="6"
                                                 Stroke="{StaticResource CyberTextDimBrush}"
                                                 StrokeThickness="1"
                                                 Fill="Transparent"
                                                 Visibility="{Binding IsTaskRunning, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                                    </Grid>

                                    <!-- Tab Name -->
                                    <TextBlock Grid.Column="1"
                                               Text="{Binding DisplayName}"
                                               Foreground="{StaticResource CyberTextBrush}"
                                               FontFamily="Consolas"
                                               FontSize="11"
                                               VerticalAlignment="Center"
                                               TextTrimming="CharacterEllipsis"
                                               Margin="6,0,0,0"/>
                                </Grid>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- Empty State -->
            <StackPanel x:Name="EmptyState"
                        Grid.Row="2"
                        VerticalAlignment="Center"
                        HorizontalAlignment="Center"
                        Visibility="Collapsed">
                <TextBlock Text="&#x25C7;"
                           Foreground="{StaticResource CyberTextDimBrush}"
                           FontSize="32"
                           HorizontalAlignment="Center"
                           Opacity="0.5"/>
                <TextBlock Text="暂无终端会话"
                           Foreground="{StaticResource CyberTextDimBrush}"
                           FontFamily="Consolas"
                           FontSize="13"
                           HorizontalAlignment="Center"
                           Margin="0,10,0,0"/>
            </StackPanel>
        </Grid>
    </Border>
</Window>
